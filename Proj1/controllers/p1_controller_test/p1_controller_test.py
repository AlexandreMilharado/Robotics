import sys
import os


# Add the parent 'controllers' directory to sys.path
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from p1_util.evolution_manager import Evolution_Manager
from p1_util.Individual import Individual
from p1_util.Networks import ComplexNet, SimpleNet

#TODO MUDAR CONSOANTE O TESTE
INDIVIDUAL_TYPE = "NETWORKS_COMPLEX"            # "BRAITENBERG" | "NETWORKS_SIMPLE" | "NETWORKS_COMPLEX"

# Simulation parameters
    # Webots
TIME_STEP_MULTIPLIER = 6.4                      # Webots timestep 
EVALUATION_TIME = 100                           # Simulated seconds per individual

    # Evolutionary
        # Model
GET_LAST_GEN = False
GEN_DUMMY = 0

# Saving and Loading
INDIVIDUALS_HISTORY_PATH_BRAITENBERG = "../p1_util/experiements/braitenberg/1/evolutionary.csv"    # Path for Individuals History
BEST_INDIVIDUAL_PATH_BRAITENBERG = "../p1_util/experiements/braitenberg/1/best_individual.pkl"     # Path for Best Individual

INDIVIDUALS_HISTORY_PATH_SIMPLE_NET = "../p1_util/experiements/simple_net/best/evolutionary.csv"    # Path for Individuals History
BEST_INDIVIDUAL_PATH_SIMPLE_NET = "../p1_util/experiements/simple_net/best/best_individual.pkl"     # Path for Best Individual

INDIVIDUALS_HISTORY_PATH_COMPLEX_NET = "../p1_util/experiements/complex_net/best/evolutionary.csv"    # Path for Individuals History
BEST_INDIVIDUAL_PATH_COMPLEX_NET = "../p1_util/experiements/complex_net/best/best_individual.pkl"     # Path for Best Individual

# Main evolutionary loop
def main():
    match INDIVIDUAL_TYPE:
        case "BRAITENBERG":
            path_history = INDIVIDUALS_HISTORY_PATH_BRAITENBERG
            path_individual = BEST_INDIVIDUAL_PATH_BRAITENBERG

            #TODO Uncomment to run 720 Individual 
            # individual = Individual(GEN_DUMMY, 720, [0.5818134621986009, 0.13865807793908047, 0.8125796317561428, 1, 0.24085906907650848, 0.40787192861437127])

            #TODO Uncomment to run 1126 Individual 
            # individual = Individual(GEN_DUMMY, 1126, [0.18918084857689133, 0.23754154363231408, 0.7202805237750275, 0.9845485173658222, 0.4276338615388701, -0.12603463192806347])

            #TODO Uncomment to run 3102 Individual  
            individual = Individual(GEN_DUMMY, 3102, [1, 0.44862598044379165, 0.48194306541659676, 0.8586086049567916, 0.9521240186655022, 0.03753195123846662])

        case "NETWORKS_SIMPLE":
            # Best Individual on last Generation
            path_history = INDIVIDUALS_HISTORY_PATH_SIMPLE_NET
            path_individual = BEST_INDIVIDUAL_PATH_SIMPLE_NET

            ## Black Line
            #TODO Uncomment to run 1637 Individual
            # individual = SimpleNet(GEN_DUMMY, 1637, [-0.043621383491984744, 0.07145413568572226, -1, 0.3010024940572799, 0.5976408592119722, 0.8762950694381357, -1, -0.09577434796970619, 0.955340669001795, 0.24301711129691567, -0.756754061100468, -0.7719266165011337, 0.5377076746054196, -1, 0.9969978025526554, -1, 0.8874557601884197, -1, 0.8548485406744881, -0.362445586493663, -0.18512840744961911, 0.16594878006229025])
            
            #TODO Uncomment to run 3125 Individual
            # individual = SimpleNet(GEN_DUMMY, 3125, [0.5869619680235721, -0.9795696539104428, -0.7916821602783721, -0.8441546725546328, 0.9751658354941617, 0.8985716428667162, -0.9442268592130283, -0.38396608524310544, -0.3388930258220551, 0.8701585973687939, -0.7898464989766424, -0.5841368400625375, -0.7755439089406573, -0.9136484460226939, 0.8993666743270459, -0.9850006322087818, -0.9651707424083783, 0.07213926100975632, 0.9708071331851227, 0.44505857270231775, -0.5687979394377852, 0.9698723162524023])
            
            #TODO Uncomment to run 7221 Individual 
            individual = SimpleNet(GEN_DUMMY, 7221, [-0.9484698409854921, 0.6598759107773684, -0.5095500921534255, -0.8614541022863407, 0.7987480117135004, 0.5916484153637585, -0.30942366969565094, -0.24405961604694743, -0.9012619357772516, 0.730737112752867, -0.028453911870992263, -1.0, -0.8881204985511026, -0.6769560352517451, 0.1136556914717895, 0.2887521061208912, -0.05115651031046836, -0.9905591879847275, 1.0, -0.5318621298911128, 0.9941904945064516, 0.21732206108884689])

            ## -- NOT RECOMMENDED -- Obstacle - Further processing is needed
            # Uncomment to run 713 Individual
            # individual = SimpleNet(GEN_DUMMY, 713, [0.7338247438148813, -0.5675784918680562, -0.7533297171284252, 0.48073090068220237, 0.2310436796712052, 1, -1, 0.035110543567603195, -0.15161314409991514, 1, 0.20894430751548865, 0.4131376277769783, -1, 0.46625020907395653, -0.05505241372528344, -1, -1, 0.00233889129494691, 0, 0, 0, 0, 0, 0, 0.018750457927249886, -1, -0.4184586087472153, -1, -0.9556172380402945, -0.08689166557526207, -1, 0.551691517972846, 0.39325779561845453, -0.7940926935755879, -0.008744003813656143, -0.9907592358789148, 0, 0])
            # Uncomment to run 2815 Individual
            # individual = SimpleNet(GEN_DUMMY, 2815, [-0.0526471728176896, -0.20077866217521, 0.04983578304795727, 0.3494852758285263, 0.24430211757107018, -1, 0.41671250059024556, -0.24167325866663972, 0.3823491668922202, 0.0002329031120035241, -0.30958487111745014, -0.5173113761430044, -0.284152922487296, -0.19127484660888877, -0.034734209042819736, -0.2568700631053471, -0.3201014202565545, -0.5942535149101883, 0, 0, 0, 0, 0, 0, 0.30598950450208456, 0.6112512430628934, 1, 0.4211465340897641, 0.18327776457077516, -0.16962996094364352, -0.10478612626560901, 0.02724055064698192, 0.020640144762629868, -0.4480762546689421, -0.44598265282949195, -0.5500768427168481, 0, 0])
            # Uncomment to run 5078 Individual
            # individual = SimpleNet(GEN_DUMMY, 5078, [0.9219143870275907, 0.5823733425510516, 0.2208237861285511, -0.6660462985514353, 0.49820971175648127, 0.44231179973788576, -1, -0.4536519851485566, 0.29088355047309405, -0.18496189528197285, 0.42824779911349, 0.566098305880921, -0.11617089394456706, 0.023673695683293042, 0.22956230429950558, -0.7092148114503845, 0.004994992466273315, 0.3358431682990998, 0, 0, 0, 0, 0, 0, -0.9764445762200997, 0.04209191991602208, -0.4492406055007087, 0.4686624849687699, 0.6715468309242497, -0.47637466117902094, -0.9808903069133581, -0.48859007308001495, 0.6721687603062454, -0.11143596241348892, -0.7169811954891323, 0.349218349914197, 0, 0])
                
        case _:
            path_history = INDIVIDUALS_HISTORY_PATH_COMPLEX_NET
            path_individual = BEST_INDIVIDUAL_PATH_COMPLEX_NET

            #TODO Uncomment to run 2870 Individual
            # individual = ComplexNet(GEN_DUMMY, 2870, [0.55720935169152, 0.4853314160173374, -0.6240412716571518, 0.4772204825851762, -0.2649333001351342, 0.21459938972561052, 0.12195971985522824, 0.5336441712277673, 0.5969662614950149, 0.5001243418129575, 0.7230817821282409, 0.4001245204336137, 0.44435744394072846, 0.10840983363040965, -0.2463928701134379, -0.22446650916700775, -0.3906932771414603, -0.4092042187977345, -0.6597030764591636, -0.02394033913633828, 1, -0.30275727445629097, -0.2605638676868044, 0.25499020972578423, -0.15520900429274267, -0.41270808909424994, 0.07284592659997463, 0.10529793271626682, -0.3094565052926801, 1, -0.09099563623434892, 0.16860828222799895, -0.3466739831814679, 0.6665110124336562, 0.44480274893156335, -0.6844932394983118, 0.9361723994288625, 0.6314712272764043, 0.4335289276120011, -0.7219036389771523, -0.23441002991513918, -0.20571317184448204])

            #TODO Uncomment to run 5933 Individual
            individual = ComplexNet(GEN_DUMMY, 5933, [0.401714358373787, 0.018437213410354536, 0.5001656874403275, 0.11680268659931367, -0.2434840687652491, 0.48132184444881937, 0.06488433539290756, -0.0011696943797036424, 0.08480430031554337, 0.06812268052722177, 0.1134386130929032, -0.6633079468999834, -0.24932531912911593, 0.36245101602155827, -0.3060386450452781, -0.1855492992467082, 0.06616935930910385, 0.4810082923435123, -0.20601507588450502, 0.34112187687385087, -0.019720143022695737, 0.696358839176458, 0.20766753805752514, -0.04006852777001042, -0.07324538046964221, -0.5557498738772472, -0.231967917083305, -0.2880860779939568, -0.4948416921924478, 0.6308146727796807, -0.8396325356222873, -0.23870926615126123, 0.8393420363082513, 0.29092458690871653, 0.1656616159566428, 0.6835464952261985, -0.17643177692370382, 0.30606652885000696, -0.07745149964959175, 0.7904078784903417, 0.2374075717495175, 0.2759014687040587])

            #TODO Uncomment to run 7768  Individual
            # individual = ComplexNet(GEN_DUMMY, 7768,[0.7000307392098887, -0.7225281394225902, 0.42728809878021023, 0.10192863445106372, -0.8964859976448711, 0.1636405147478285, -0.15687224015912205, -0.24823443032807685, 0.024961597086899295, -0.611205031630336, 1, 1, 0.22447362675015764, 0.302899021939074, 0.22910939606394123, 0.6469205772632642, -0.000597768231530682, 0.9772583373942438, 0.4494270775859543, -0.12380610862043434, -0.802750724926457, 0.2662669452581087, 0.41614311100770307, 0.0959411839452145, -0.7838288395143396, -0.40728776899797314, -0.4154866787176267, -1, -0.8324860398097859, 0.4119444405111113, 0.4929987880152409, -0.4002662116465504, -1, -0.5996996846787266, 0.365338776922816, 0.3295168984612641, -0.7180765380504945, 0.07614140082692358, 0.1463732966977292, 0.5682526749983334, -0.7553676890592153, -0.4897955716632132])

    # Run the evolutionary algorithm
    controller = Evolution_Manager( INDIVIDUAL_TYPE = INDIVIDUAL_TYPE,
                                    TIMESTEP_MULTIPLIER = TIME_STEP_MULTIPLIER,
                                    INDIVIDUALS_HISTORY_PATH = path_history,
                                    BEST_INDIVIDUAL_PATH = path_individual)

    if GET_LAST_GEN:
        individual = controller.load_best_individual_on_last_gen()
      
    controller.run_individual(individual)

if __name__ == "__main__":
    main()