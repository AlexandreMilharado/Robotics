import sys
import os


# Add the parent 'controllers' directory to sys.path
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from p1_util.evolution_manager import Evolution_Manager
from p1_util.Individual import Individual
from p1_util.Networks import ComplexNet, SimpleNet

#TODO MUDAR CONSOANTE O TESTE
INDIVIDUAL_TYPE = "NETWORKS_COMPLEX"            # "BRAITENBERG" | "NETWORKS_SIMPLE" | "NETWORKS_COMPLEX"

# Simulation parameters
    # Webots
TIME_STEP_MULTIPLIER = 6.4                      # Webots timestep 
EVALUATION_TIME = 100                           # Simulated seconds per individual

    # Evolutionary
        # Model
GET_LAST_GEN = False
GEN_DUMMY = 0

# Saving and Loading
INDIVIDUALS_HISTORY_PATH_BRAITENBERG = "../p1_util/experiements/braitenberg/1/evolutionary.csv"    # Path for Individuals History
BEST_INDIVIDUAL_PATH_BRAITENBERG = "../p1_util/experiements/braitenberg/1/best_individual.pkl"     # Path for Best Individual

INDIVIDUALS_HISTORY_PATH_SIMPLE_NET = "../p1_util/experiements/simple_net/best/evolutionary.csv"    # Path for Individuals History
BEST_INDIVIDUAL_PATH_SIMPLE_NET = "../p1_util/experiements/simple_net/best/best_individual.pkl"     # Path for Best Individual

INDIVIDUALS_HISTORY_PATH_COMPLEX_NET = "../p1_util/experiements/complex_net/best/evolutionary.csv"    # Path for Individuals History
BEST_INDIVIDUAL_PATH_COMPLEX_NET = "../p1_util/experiements/complex_net/best/best_individual.pkl"     # Path for Best Individual

# Main evolutionary loop
def main():
    match INDIVIDUAL_TYPE:
        case "BRAITENBERG":
            path_history = INDIVIDUALS_HISTORY_PATH_BRAITENBERG
            path_individual = BEST_INDIVIDUAL_PATH_BRAITENBERG

            #TODO Uncomment to run 720 Individual 
            # individual = Individual(GEN_DUMMY, 720, [0.5818134621986009, 0.13865807793908047, 0.8125796317561428, 1, 0.24085906907650848, 0.40787192861437127])

            #TODO Uncomment to run 1126 Individual 
            # individual = Individual(GEN_DUMMY, 1126, [0.18918084857689133, 0.23754154363231408, 0.7202805237750275, 0.9845485173658222, 0.4276338615388701, -0.12603463192806347])

            #TODO Uncomment to run 3102 Individual  
            individual = Individual(GEN_DUMMY, 3102, [1, 0.44862598044379165, 0.48194306541659676, 0.8586086049567916, 0.9521240186655022, 0.03753195123846662])

        case "NETWORKS_SIMPLE":
            # Best Individual on last Generation
            path_history = INDIVIDUALS_HISTORY_PATH_SIMPLE_NET
            path_individual = BEST_INDIVIDUAL_PATH_SIMPLE_NET

            ## Black Line
            #TODO Uncomment to run 1637 Individual
            # individual = SimpleNet(GEN_DUMMY, 1637, [-0.043621383491984744, 0.07145413568572226, -1, 0.3010024940572799, 0.5976408592119722, 0.8762950694381357, -1, -0.09577434796970619, 0.955340669001795, 0.24301711129691567, -0.756754061100468, -0.7719266165011337, 0.5377076746054196, -1, 0.9969978025526554, -1, 0.8874557601884197, -1, 0.8548485406744881, -0.362445586493663, -0.18512840744961911, 0.16594878006229025])
            
            #TODO Uncomment to run 3125 Individual
            # individual = SimpleNet(GEN_DUMMY, 3125, [0.5869619680235721, -0.9795696539104428, -0.7916821602783721, -0.8441546725546328, 0.9751658354941617, 0.8985716428667162, -0.9442268592130283, -0.38396608524310544, -0.3388930258220551, 0.8701585973687939, -0.7898464989766424, -0.5841368400625375, -0.7755439089406573, -0.9136484460226939, 0.8993666743270459, -0.9850006322087818, -0.9651707424083783, 0.07213926100975632, 0.9708071331851227, 0.44505857270231775, -0.5687979394377852, 0.9698723162524023])
            
            #TODO Uncomment to run 7221 Individual 
            individual = SimpleNet(GEN_DUMMY, 7221, [-0.9484698409854921, 0.6598759107773684, -0.5095500921534255, -0.8614541022863407, 0.7987480117135004, 0.5916484153637585, -0.30942366969565094, -0.24405961604694743, -0.9012619357772516, 0.730737112752867, -0.028453911870992263, -1.0, -0.8881204985511026, -0.6769560352517451, 0.1136556914717895, 0.2887521061208912, -0.05115651031046836, -0.9905591879847275, 1.0, -0.5318621298911128, 0.9941904945064516, 0.21732206108884689])

            ## -- NOT RECOMMENDED -- Obstacle - Further processing is needed
            # Uncomment to run 713 Individual
            # individual = SimpleNet(GEN_DUMMY, 713, [0.7338247438148813, -0.5675784918680562, -0.7533297171284252, 0.48073090068220237, 0.2310436796712052, 1, -1, 0.035110543567603195, -0.15161314409991514, 1, 0.20894430751548865, 0.4131376277769783, -1, 0.46625020907395653, -0.05505241372528344, -1, -1, 0.00233889129494691, 0, 0, 0, 0, 0, 0, 0.018750457927249886, -1, -0.4184586087472153, -1, -0.9556172380402945, -0.08689166557526207, -1, 0.551691517972846, 0.39325779561845453, -0.7940926935755879, -0.008744003813656143, -0.9907592358789148, 0, 0])
            # Uncomment to run 2815 Individual
            # individual = SimpleNet(GEN_DUMMY, 2815, [-0.0526471728176896, -0.20077866217521, 0.04983578304795727, 0.3494852758285263, 0.24430211757107018, -1, 0.41671250059024556, -0.24167325866663972, 0.3823491668922202, 0.0002329031120035241, -0.30958487111745014, -0.5173113761430044, -0.284152922487296, -0.19127484660888877, -0.034734209042819736, -0.2568700631053471, -0.3201014202565545, -0.5942535149101883, 0, 0, 0, 0, 0, 0, 0.30598950450208456, 0.6112512430628934, 1, 0.4211465340897641, 0.18327776457077516, -0.16962996094364352, -0.10478612626560901, 0.02724055064698192, 0.020640144762629868, -0.4480762546689421, -0.44598265282949195, -0.5500768427168481, 0, 0])
            # Uncomment to run 5078 Individual
            # individual = SimpleNet(GEN_DUMMY, 5078, [0.9219143870275907, 0.5823733425510516, 0.2208237861285511, -0.6660462985514353, 0.49820971175648127, 0.44231179973788576, -1, -0.4536519851485566, 0.29088355047309405, -0.18496189528197285, 0.42824779911349, 0.566098305880921, -0.11617089394456706, 0.023673695683293042, 0.22956230429950558, -0.7092148114503845, 0.004994992466273315, 0.3358431682990998, 0, 0, 0, 0, 0, 0, -0.9764445762200997, 0.04209191991602208, -0.4492406055007087, 0.4686624849687699, 0.6715468309242497, -0.47637466117902094, -0.9808903069133581, -0.48859007308001495, 0.6721687603062454, -0.11143596241348892, -0.7169811954891323, 0.349218349914197, 0, 0])
                
        case _:
            path_history = INDIVIDUALS_HISTORY_PATH_COMPLEX_NET
            path_individual = BEST_INDIVIDUAL_PATH_COMPLEX_NET

            #TODO Uncomment to run 759 Individual
            # individual = ComplexNet(GEN_DUMMY, 759,[0.04579802377021036, -0.8038303114096843, 0.757789212716654, 0.35336277093712354, 0.6590790943804846, 0.14660076119269594, -0.7741099898485932, -0.6566691250294531, -0.3722423486885348, -0.5322733240081934, 0.49921946766567826, -0.9605769038933454, 0.5902993842763692, -0.9881127910259515, 0.8523777265287815, -0.2694786103063015, -0.5197012607372529, -0.7680987557415697, 0.39566083158043597, 0.6154669526621999, 0.9732797591324032, -0.11431059486020101, -0.0769228451076662, -0.37518719392971245, -0.534503366509849, -0.3888543385286941, -0.08356767882434102, -0.7112871182278044, -0.47799454191644775, 0.8175257503424745, -0.0896587927191761, -0.055441501615948595, 0.3006283590255361, 0.1485947906957199, -0.19462091080401722, 0.9948251576332002, 0.38725986413057767, 0.44232756971864573, -0.1385292248303029, 0.24076206461290428, -0.22852610360167383, -0.7756565445314817, -0.39019631853421843, -0.13188643444747133, -0.742625903291929, 0.5102595114314609, 0.3496508765725257, 0.17501072165940967, 0.2294618675046593, -0.5658717470156535, -0.42628166364924397, -0.48517321638137223, -0.37243362591598045, -0.2990352570662682, 0.6133752501268996, -0.07176567663061906, -0.46385164347054353, 0.07206575085933797, -0.4437975194834619, -0.33226192357207973, 0.32621478279463023, -0.27014883391993383, -0.3755917885392608, -0.2576402317870376, 0.1802918147974042, 0.19443950501604823, -0.8316049257255711, 0.16853947645166212, -0.09537851562140308, 0.31710785231488975, -0.4865365916670187, 0.821370827950814, -0.8911352125988953, 0.42314986467408233, -0.7998340664907286, -0.5111083696404687, 0.5535452387803127, -0.6475465393346002, 0.5258392773141766, 0.9587717144128778, 0.3077452934566718, -0.32385796655637156, 0.1115214566255357, 0.7026434957452923, -0.34462000087452505, -0.17639459300852647, -0.3125548737755668, -0.0038051038437881823, -0.11306850439708555, 0.700241619276719, -0.23172955424852376, -0.27925989531496204, -0.0016318313626679792, -0.3865146842487772, -0.4932937936981863, -0.11775962810563818, 0.5447311562199029, 0.4420979769555115, 0.5304625648563899, -0.49148017388793597, 0.05643386490469083, 0.8988936620252205, 0.7809857761366568, -0.0720323128933531, 0.5808139526409994, 0.9059736811943511, 0.5924442184150917, 0.23691859847145047, 0.34779085536159327, -0.37463649610154826, -0.23218840571141508, 0.37934079213530414])

            #TODO Uncomment to run 6134 Individual
            individual = ComplexNet(GEN_DUMMY, 6134,[0.401714358373787, 0.018437213410354536, 0.5001656874403275, 0.11680268659931367, -0.2434840687652491, 0.48132184444881937, 0.06488433539290756, -0.0011696943797036424, 0.08480430031554337, 0.06812268052722177, 0.1134386130929032, -0.6633079468999834, -0.24932531912911593, 0.36245101602155827, -0.3060386450452781, -0.1855492992467082, 0.06616935930910385, 0.4810082923435123, -0.20601507588450502, 0.34112187687385087, -0.019720143022695737, 0.696358839176458, 0.20766753805752514, -0.04006852777001042, -0.07324538046964221, -0.5557498738772472, -0.231967917083305, -0.2880860779939568, -0.4948416921924478, 0.6308146727796807, -0.8396325356222873, -0.23870926615126123, 0.8393420363082513, 0.29092458690871653, 0.1656616159566428, 0.6835464952261985, -0.17643177692370382, 0.30606652885000696, -0.07745149964959175, 0.7904078784903417, 0.2374075717495175, 0.2759014687040587])


    # Run the evolutionary algorithm
    controller = Evolution_Manager( INDIVIDUAL_TYPE = INDIVIDUAL_TYPE,
                                    TIMESTEP_MULTIPLIER = TIME_STEP_MULTIPLIER,
                                    INDIVIDUALS_HISTORY_PATH = path_history,
                                    BEST_INDIVIDUAL_PATH = path_individual)

    if GET_LAST_GEN:
        individual = controller.load_best_individual_on_last_gen()
      
    controller.run_individual(individual)

if __name__ == "__main__":
    main()